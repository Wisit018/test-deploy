# Step 2 - ข้อมูลการจัดส่ง (Delivery Data Sources)

## ภาพรวม
Step 2 ใช้สำหรับเลือกหรือสร้างข้อมูลการจัดส่ง โดยจะดึงข้อมูลจาก 2 แหล่งหลัก:
1. **ข้อมูลลูกค้าที่เลือกจาก Step 1** - ใช้สำหรับแสดงข้อมูลลูกค้าและ auto-fill ฟอร์ม
2. **ประวัติการจัดส่ง** - รายการจัดส่งเดิมที่เคยบันทึกไว้

## ข้อมูลที่แสดงในฟอร์มการจัดส่ง

### ข้อมูลจาก Step 1 (Customer Data)
เมื่อเลือกลูกค้าใน Step 1 ข้อมูลต่อไปนี้จะถูกส่งมาที่ Step 2:

#### ข้อมูลลูกค้าพื้นฐาน
- **customerid**: รหัสลูกค้า
- **prename**: คำนำหน้า (คุณ, นาย, นาง, นางสาว)
- **firstname**: ชื่อ
- **lastname**: นามสกุล
- **mobiletel**: เบอร์โทรศัพท์มือถือ

#### ข้อมูลที่อยู่ลูกค้า (ใช้สำหรับ auto-fill)
- **addr1**: ที่อยู่บรรทัดหลัก
- **addr2**: ที่อยู่บรรทัดเพิ่มเติม
- **addr3**: ที่อยู่อื่น ๆ 1
- **addr4**: ที่อยู่อื่น ๆ 2
- **addr5**: ที่อยู่อื่น ๆ 3
- **homenum**: บ้านเลขที่
- **mooban**: หมู่บ้าน/หมู่ที่
- **building**: หมู่บ้าน/หมู่ที่
- **soi**: ซอย
- **road**: ถนน
- **kate**: เขต/อำเภอ
- **kwang**: แขวง/ตำบล
- **zipcode**: รหัสไปรษณีย์
- **province**: จังหวัด

### ข้อมูลการจัดส่ง (Delivery Form Fields)

#### ข้อมูลผู้รับ
- **deliverto**: ชื่อผู้รับ (required)
- **appttel**: เบอร์โทรผู้รับ (required)

#### ข้อมูลวันที่และเวลา
- **day**: วันที่จัดส่ง (date picker)
- **timein**: เวลาจัดส่ง (time picker)

#### ข้อมูลที่อยู่จัดส่ง
- **addr1**: ชื่อ-นามสกุล (required) - ดึงข้อมูลจาก prename + firstname + lastname ของลูกค้า
- **addr2**: ที่อยู่บรรทัดหลัก - ดึงข้อมูลจาก addr2 ของลูกค้า
- **addr3**: ที่อยู่บรรทัดเพิ่มเติม - ดึงข้อมูลจาก addr3 ของลูกค้า
- **homenum1**: บ้านเลขที่
- **mooban1**: หมู่บ้าน/หมู่ที่
- **soi1**: ซอย
- **road1**: ถนน
- **kwang1**: แขวง/ตำบล
- **kate1**: เขต/อำเภอ
- **province1**: จังหวัด
- **zipcode1**: รหัสไปรษณีย์

## การทำงานของระบบ

### 1. การแสดงข้อมูลลูกค้า
เมื่อเข้าสู่ Step 2 ระบบจะ:
- ดึงข้อมูลลูกค้าจาก API: `/workflow/api/customers/{customerId}/deliveries`
- แสดงข้อมูลลูกค้าในส่วน "ข้อมูลลูกค้าที่เลือกไว้"
- ข้อมูลที่แสดง: รหัสลูกค้า, ชื่อ-สกุล, เบอร์ติดต่อ, ที่อยู่

### 2. การแสดงประวัติการจัดส่ง
ระบบจะแสดงรายการจัดส่ง 2 ประเภท:
- **รายการที่บันทึกไว้ในระบบ**: ข้อมูลจริงจากฐานข้อมูล
- **รายการร่าง**: ข้อมูลที่สร้างขึ้นแต่ยังไม่ได้บันทึก

### 3. การเลือกข้อมูลจัดส่ง
เมื่อเลือกรายการจัดส่ง (radio button):
- ข้อมูลจะถูกโหลดเข้าไปในฟอร์มแก้ไข
- ฟอร์มจะเปลี่ยนเป็นโหมด "แก้ไขข้อมูลจัดส่ง"
- ข้อมูลจะถูก auto-fill ตามรายการที่เลือก

### 4. การสร้างข้อมูลจัดส่งใหม่
เมื่อสร้างรายการใหม่:
- ฟอร์มจะอยู่ในโหมด "เพิ่มข้อมูลจัดส่งใหม่"
- สามารถ auto-fill ข้อมูลจากข้อมูลลูกค้าได้
- ข้อมูลจะถูกบันทึกเป็นร่างใน sessionStorage

## การ Auto-fill ข้อมูล

### จากข้อมูลลูกค้า
เมื่อกดปุ่ม "เริ่มต้นการจัดส่ง" หรือแก้ไขรายการ:
- **deliverto**: ใช้ชื่อลูกค้า (firstname + lastname)
- **appttel**: ใช้เบอร์โทรลูกค้า (mobiletel)
- **addr1**: ใช้ชื่อ-นามสกุลลูกค้า (prename + firstname + lastname)
- **addr2**: ใช้ที่อยู่บรรทัดหลักลูกค้า (addr2)
- **addr3**: ใช้ที่อยู่บรรทัดเพิ่มเติมลูกค้า (addr3)
- **homenum1**: ใช้บ้านเลขที่ลูกค้า (homenum)
- **mooban1**: ใช้หมู่บ้านลูกค้า (mooban)
- **soi1**: ใช้ซอยลูกค้า (soi)
- **road1**: ใช้ถนนลูกค้า (road)
- **kwang1**: ใช้แขวงลูกค้า (kwang)
- **kate1**: ใช้เขตลูกค้า (kate)
- **province1**: ใช้จังหวัดลูกค้า (province)
- **zipcode1**: ใช้รหัสไปรษณีย์ลูกค้า (zipcode)

### จากประวัติการจัดส่ง
เมื่อเลือกรายการจัดส่งเดิม:
- ข้อมูลทั้งหมดจะถูกโหลดจากรายการที่เลือก
- ฟอร์มจะแสดงข้อมูลเดิมที่เคยบันทึกไว้
- สามารถแก้ไขข้อมูลได้ตามต้องการ

## การบันทึกข้อมูล

### รายการร่าง (Draft)
- บันทึกใน sessionStorage
- สามารถแก้ไขหรือลบได้
- จะไม่ถูกบันทึกลงฐานข้อมูลจนกว่าจะจบ Step 5

### รายการที่บันทึกแล้ว (Saved)
- บันทึกในฐานข้อมูลแล้ว
- สามารถเลือกใช้ได้
- การแก้ไขจะสร้างรายการใหม่

## API Endpoints ที่ใช้

1. **GET /workflow/api/customers/{customerId}/deliveries**
   - ดึงข้อมูลลูกค้าและประวัติการจัดส่ง
   - Response: `{ customer: {...}, deliveries: [...] }`

2. **POST /workflow/api/deliveries** (ถ้ามี)
   - บันทึกข้อมูลจัดส่งใหม่
   - ใช้สำหรับการสร้างรายการจัดส่ง

## การทำงานของฟังก์ชันหลัก

### `handleSelect(id)`
- จัดการการเลือกรายการจัดส่ง
- โหลดข้อมูลเข้าไปในฟอร์ม
- เปลี่ยนโหมดฟอร์มเป็น "แก้ไข"
- อัพเดตสถานะการเลือก

### `populateForm(record)`
- เติมข้อมูลลงในฟอร์ม
- จัดการข้อมูลวันที่และเวลา
- แสดง/ซ่อนฟิลด์ตามข้อมูลที่มี

### `createDraftFromCustomer()`
- สร้างรายการร่างจากข้อมูลลูกค้า
- Auto-fill ข้อมูลที่อยู่จากข้อมูลลูกค้า
- เตรียมข้อมูลสำหรับการจัดส่ง
