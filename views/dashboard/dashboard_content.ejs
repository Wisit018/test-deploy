<style>
    .card-stat {
        transition: transform 0.2s;
    }
    .card-stat:hover {
        transform: translateY(-2px);
    }
    .table-responsive {
        max-height: 600px;
        overflow-y: auto;
    }
    .badge-type {
        font-size: 0.75rem;
    }
    .text-truncate-custom {
        max-width: 150px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
</style>

<!-- Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="h3 mb-0">
                <i class="bi bi-speedometer2 me-2"></i>
                Dashboard - ข้อมูลการจัดส่ง
            </h1>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-primary" onclick="location.reload()">
                    <i class="bi bi-arrow-clockwise me-1"></i>
                    รีเฟรช
                </button>
                <button class="btn btn-primary" onclick="exportToCSV()">
                    <i class="bi bi-download me-1"></i>
                    ส่งออก CSV
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card card-stat bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">จำนวนรายการทั้งหมด</h6>
                        <h4 class="mb-0"><%= summary.total %></h4>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-list-ul fs-1 opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card card-stat bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">รายการขาย</h6>
                        <h4 class="mb-0"><%= summary.sales %></h4>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-cart-check fs-1 opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card card-stat bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">ค่าส่ง</h6>
                        <h4 class="mb-0"><%= summary.shipping %></h4>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-truck fs-1 opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card card-stat bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">ของแถม</h6>
                        <h4 class="mb-0"><%= summary.free %></h4>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-gift fs-1 opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Additional Summary -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card card-stat bg-dark text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">ยอดรวมทั้งหมด</h6>
                        <h4 class="mb-0">฿<%= parseFloat(summary.totalAmount).toLocaleString('th-TH', {minimumFractionDigits: 2}) %></h4>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-currency-dollar fs-1 opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card card-stat bg-secondary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">อัปเดตล่าสุด</h6>
                        <h6 class="mb-0"><%= new Date().toLocaleString('th-TH') %></h6>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-clock fs-1 opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Search and Filter -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-3">
                <label for="searchInput" class="form-label">ค้นหา</label>
                <input type="text" class="form-control" id="searchInput" placeholder="ค้นหาจากหมายเลขการจัดส่ง, ชื่อลูกค้า, หรือสินค้า...">
            </div>
            <div class="col-md-2">
                <label for="typeFilter" class="form-label">ประเภท</label>
                <select class="form-select" id="typeFilter">
                    <option value="">ทั้งหมด</option>
                    <option value="ขาย">ขาย</option>
                    <option value="ค่าส่ง">ค่าส่ง</option>
                    <option value="ของแถม">ของแถม</option>
                </select>
            </div>
            <div class="col-md-2">
                <label for="dateFilter" class="form-label">วันที่</label>
                <input type="date" class="form-control" id="dateFilter">
            </div>
            <div class="col-md-2">
                <label for="operatorFilter" class="form-label">พนักงาน</label>
                <select class="form-select" id="operatorFilter">
                    <option value="">ทั้งหมด</option>
                    <% const uniqueOperators = [...new Set(deliveries.map(d => d.operator).filter(Boolean))]; %>
                    <% uniqueOperators.forEach(operator => { %>
                        <option value="<%= operator %>"><%= operator %></option>
                    <% }); %>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">&nbsp;</label>
                <button class="btn btn-outline-danger d-block w-100" onclick="clearFilters()">
                    <i class="bi bi-x-circle me-1"></i>
                    ล้างตัวกรอง
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Data Table -->
<div class="card">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="bi bi-table me-2"></i>
            ข้อมูลการจัดส่ง (แสดง 100 รายการล่าสุด)
        </h5>
        <small class="text-muted">คลิกที่แถวเพื่อดูรายละเอียด</small>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0" id="deliveriesTable">
                <thead class="table-light sticky-top">
                    <tr>
                        <th>ID</th>
                        <th>หมายเลขการจัดส่ง</th>
                        <th>วันที่/เวลา</th>
                        <th>พนักงาน</th>
                        <th>ลูกค้า</th>
                        <th>ประเภท</th>
                        <th>สินค้า</th>
                        <th>จำนวน</th>
                        <th>ราคา</th>
                        <th>ยอดรวม</th>
                        <th>ช่องทาง</th>
                        <th>การชำระเงิน</th>
                        <th>การขนส่ง</th>
                        <th>วันที่ส่ง</th>
                        <th>ผู้รับ</th>
                        <th>โทรศัพท์</th>
                        <th>ที่อยู่</th>
                        <th>อีเมล</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (deliveries && deliveries.length > 0) { %>
                        <% deliveries.forEach(function(delivery) { %>
                            <tr data-type="<%= delivery.datadesc || '' %>" data-date="<%= delivery.workdate || '' %>" data-operator="<%= delivery.operator || '' %>">
                                <td><%= String(delivery.id || '').trim() %></td>
                                <td>
                                    <span class="badge bg-primary badge-type"><%= String(delivery.delivernum || '').trim() %></span>
                                </td>
                                <td>
                                    <small>
                                        <div><%= String(delivery.workdate || '').trim() %></div>
                                        <div class="text-muted"><%= String(delivery.worktime || '').trim() %></div>
                                    </small>
                                </td>
                                <td><%= String(delivery.operator || '').trim() %></td>
                                <td>
                                    <div>
                                        <strong><%= String((delivery.prename || '') + ' ' + (delivery.firstname || '') + ' ' + (delivery.lastname || '')).trim() %></strong>
                                    </div>
                                    <small class="text-muted">ID: <%= String(delivery.customerid || '').trim() %></small>
                                </td>
                                <td>
                                    <% if (delivery.datadesc === 'ขาย') { %>
                                        <span class="badge bg-success badge-type">ขาย</span>
                                    <% } else if (delivery.datadesc === 'ค่าส่ง') { %>
                                        <span class="badge bg-info badge-type">ค่าส่ง</span>
                                    <% } else if (delivery.datadesc === 'ของแถม') { %>
                                        <span class="badge bg-warning text-dark badge-type">ของแถม</span>
                                    <% } else { %>
                                        <span class="badge bg-secondary badge-type"><%= delivery.datadesc || '' %></span>
                                    <% } %>
                                </td>
                                <td>
                                    <div class="text-truncate-custom" title="<%= String(delivery.title || '').trim() %>">
                                        <%= String(delivery.title || '').trim() %>
                                    </div>
                                </td>
                                <td class="text-center"><%= String(delivery.qty || 0).trim() %></td>
                                <td class="text-end">฿<%= parseFloat(delivery.price || 0).toLocaleString('th-TH', {minimumFractionDigits: 2}) %></td>
                                <td class="text-end">
                                    <strong>฿<%= parseFloat(delivery.total || 0).toLocaleString('th-TH', {minimumFractionDigits: 2}) %></strong>
                                </td>
                                <td>
                                    <div>
                                        <div><%= String(delivery.mediadesc || '').trim() %></div>
                                        <small class="text-muted"><%= String(delivery.channeldes || '').trim() %></small>
                                    </div>
                                </td>
                                <td>
                                    <div class="text-truncate-custom" title="<%= String(delivery.paydesc || '').trim() %>">
                                        <%= String(delivery.paydesc || '').trim() %>
                                    </div>
                                </td>
                                <td><%= String(delivery.shipdesc || '').trim() %></td>
                                <td>
                                    <small>
                                        <div><%= String(delivery.apptday || '').trim() %></div>
                                        <div><%= String(delivery.apptdate || '').trim() %></div>
                                        <div class="text-muted"><%= String(delivery.appttime || '').trim() %></div>
                                    </small>
                                </td>
                                <td>
                                    <div class="text-truncate-custom" title="<%= String(delivery.apptperson || '').trim() %>">
                                        <%= String(delivery.apptperson || '').trim() %>
                                    </div>
                                </td>
                                <td>
                                    <small><%= String(delivery.appttel || '').trim() %></small>
                                </td>
                                <td>
                                    <div class="text-truncate-custom" title="<%= String(delivery.apptaddr || '').trim() %>">
                                        <%= String(delivery.apptaddr || '').trim() %>
                                    </div>
                                </td>
                                <td>
                                    <small><%= String(delivery.emailaddr || '').trim() %></small>
                                </td>
                            </tr>
                        <% }); %>
                    <% } else { %>
                        <tr>
                            <td colspan="18" class="text-center py-4">
                                <div class="text-muted">
                                    <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                    ไม่พบข้อมูลการจัดส่ง
                                </div>
                            </td>
                        </tr>
                    <% } %>
                </tbody>
            </table>
        </div>
    </div>
    <div class="card-footer text-muted">
        <small>
            แสดงข้อมูลล่าสุด <%= deliveries ? deliveries.length : 0 %> รายการ 
            | อัปเดตล่าสุด: <%= new Date().toLocaleString('th-TH') %>
        </small>
    </div>
</div>

<!-- Detail Form Section -->
<div class="card mt-4" id="detailFormSection" style="display: none;">
    <div class="card-header bg-primary text-white">
        <h5 class="card-title mb-0">
            <i class="bi bi-person-lines-fill me-2"></i>
            รายละเอียดข้อมูลการจัดส่ง
        </h5>
    </div>
    <div class="card-body">
        <div id="detailContent">
            <!-- Content will be populated by JavaScript -->
        </div>
    </div>
    <div class="card-footer">
        <div class="d-flex justify-content-between">
            <button type="button" class="btn btn-outline-secondary" onclick="hideDetailForm()">
                <i class="bi bi-x-circle me-1"></i>
                ซ่อนรายละเอียด
            </button>
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-primary" onclick="printDetail()">
                    <i class="bi bi-printer me-1"></i>
                    พิมพ์
                </button>
                <button type="button" class="btn btn-success" onclick="exportSelectedData()">
                    <i class="bi bi-download me-1"></i>
                    ส่งออกข้อมูลที่เลือก
                </button>
                <button type="button" class="btn btn-info" onclick="exportAllRelatedData()">
                    <i class="bi bi-download me-1"></i>
                    ส่งออกข้อมูลทั้งหมด
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Helper function to format date to Thai format
function formatThaiDate(dateString) {
    if (!dateString || dateString.trim() === '') return '';
    
    try {
        // ถ้าเป็นวันที่ในรูปแบบ ISO หรือ date string
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return dateString; // ถ้าแปลงไม่ได้ให้คืนค่าเดิม
        
        // แปลงเป็นรูปแบบไทย
        const thaiDate = date.toLocaleDateString('th-TH', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            timeZone: 'Asia/Bangkok'
        });
        
        return thaiDate;
    } catch (error) {
        console.error('Error formatting date:', error);
        return dateString; // ถ้าเกิดข้อผิดพลาดให้คืนค่าเดิม
    }
}

// Helper function to format time to Thai format
function formatThaiTime(timeString) {
    if (!timeString || timeString.trim() === '') return '';
    
    try {
        // ถ้าเป็นเวลาที่มีรูปแบบ HH:MM:SS
        if (timeString.match(/^\d{2}:\d{2}:\d{2}$/)) {
            return timeString;
        }
        
        // ถ้าเป็นเวลาที่มีรูปแบบอื่น
        const time = new Date(`1970-01-01T${timeString}`);
        if (isNaN(time.getTime())) return timeString;
        
        return timeString;
    } catch (error) {
        console.error('Error formatting time:', error);
        return timeString;
    }
}

// Search and filter functionality
function filterTable() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const typeFilter = document.getElementById('typeFilter').value;
    const dateFilter = document.getElementById('dateFilter').value;
    const operatorFilter = document.getElementById('operatorFilter').value;
    const table = document.getElementById('deliveriesTable');
    const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

    let visibleCount = 0;

    for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const cells = row.getElementsByTagName('td');
        const rowType = row.getAttribute('data-type');
        const rowDate = row.getAttribute('data-date');
        const rowOperator = row.getAttribute('data-operator');

        let showRow = true;

        // Search filter
        if (searchTerm) {
            let rowText = '';
            for (let j = 0; j < cells.length; j++) {
                rowText += cells[j].textContent.toLowerCase() + ' ';
            }
            if (!rowText.includes(searchTerm)) {
                showRow = false;
            }
        }

        // Type filter
        if (typeFilter && rowType !== typeFilter) {
            showRow = false;
        }

        // Date filter
        if (dateFilter && rowDate !== dateFilter) {
            showRow = false;
        }

        // Operator filter
        if (operatorFilter && rowOperator !== operatorFilter) {
            showRow = false;
        }

        row.style.display = showRow ? '' : 'none';
        if (showRow) visibleCount++;
    }

    // Update visible count in footer
    const footer = document.querySelector('.card-footer small');
    if (footer) {
        footer.innerHTML = `แสดงข้อมูล ${visibleCount} รายการ | อัปเดตล่าสุด: ${new Date().toLocaleString('th-TH')}`;
    }
}

function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('typeFilter').value = '';
    document.getElementById('dateFilter').value = '';
    document.getElementById('operatorFilter').value = '';
    filterTable();
}

async function exportToCSV() {
    try {
        // ดึงข้อมูลทั้งหมดจาก API
        const response = await fetch('/dashboard/api/all-deliveries');
        const result = await response.json();
        
        if (!result.success || !result.data || result.data.length === 0) {
            alert('ไม่มีข้อมูลให้ส่งออก');
            return;
        }
        
        // สร้าง CSV content ตามโครงสร้าง legacy_deliveries
        const csvContent = generateCSVContent(result.data);
        
        // ดาวน์โหลดไฟล์
        downloadCSV(csvContent, `ข้อมูลทั้งหมด_${new Date().toISOString().slice(0, 10)}.csv`);
        
    } catch (error) {
        console.error('Error exporting data:', error);
        alert('เกิดข้อผิดพลาดในการส่งออกข้อมูล');
    }
}

// Event listeners
document.getElementById('searchInput').addEventListener('input', filterTable);
document.getElementById('typeFilter').addEventListener('change', filterTable);
document.getElementById('dateFilter').addEventListener('change', filterTable);
document.getElementById('operatorFilter').addEventListener('change', filterTable);

// Initialize filters
document.addEventListener('DOMContentLoaded', function() {
    filterTable();
    initializeTableSelection();
});

// Table row selection and detail view
function initializeTableSelection() {
    const table = document.getElementById('deliveriesTable');
    const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

    for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        
        // Add click event listener
        row.addEventListener('click', function() {
            // Remove active class from all rows
            for (let j = 0; j < rows.length; j++) {
                rows[j].classList.remove('table-active');
            }
            
            // Add active class to clicked row
            this.classList.add('table-active');
            
            // Show detail form
            showDetailForm(this);
        });

        // Add hover effect
        row.addEventListener('mouseenter', function() {
            if (!this.classList.contains('table-active')) {
                this.style.cursor = 'pointer';
                this.style.backgroundColor = '#f8f9fa';
            }
        });

        row.addEventListener('mouseleave', function() {
            if (!this.classList.contains('table-active')) {
                this.style.backgroundColor = '';
            }
        });
    }
}

function showDetailForm(row) {
    const cells = row.getElementsByTagName('td');
    
    // Helper function to clean text content
    function cleanText(text) {
        return text.replace(/^\s+|\s+$/g, '').replace(/\s+/g, ' ');
    }
    
    // Debug: Log cell contents to see what we're getting
    console.log('Cell contents:', Array.from(cells).map((cell, index) => `${index}: "${cell.textContent}"`));
    
    const deliveryData = {
        id: cleanText(cells[0].textContent),
        delivernum: cleanText(cells[1].querySelector('.badge')?.textContent || cells[1].textContent),
        workdate: cleanText(cells[2].querySelector('div:first-child')?.textContent || cells[2].textContent.split('\n')[0]),
        worktime: cleanText(cells[2].querySelector('.text-muted')?.textContent || cells[2].textContent.split('\n')[1] || ''),
        operator: cleanText(cells[3].textContent),
        customer: cleanText(cells[4].querySelector('strong')?.textContent || cells[4].textContent.split('\n')[0]),
        customerid: cleanText(cells[4].querySelector('.text-muted')?.textContent?.replace('ID: ', '') || ''),
        datadesc: cleanText(cells[5].querySelector('.badge')?.textContent || cells[5].textContent),
        title: cleanText(cells[6].querySelector('.text-truncate-custom')?.textContent || cells[6].textContent),
        qty: cleanText(cells[7].textContent),
        price: cleanText(cells[8].textContent),
        total: cleanText(cells[9].querySelector('strong')?.textContent || cells[9].textContent),
        media: cleanText(cells[10].querySelector('div:first-child')?.textContent || cells[10].textContent.split('\n')[0]),
        channel: cleanText(cells[10].querySelector('.text-muted')?.textContent || cells[10].textContent.split('\n')[1] || ''),
        payment: cleanText(cells[11].querySelector('.text-truncate-custom')?.textContent || cells[11].textContent),
        shipping: cleanText(cells[12].textContent),
        apptday: cleanText(cells[13].querySelector('div:first-child')?.textContent || cells[13].textContent.split('\n')[0]),
        apptdate: cleanText(cells[13].querySelector('div:nth-child(2)')?.textContent || cells[13].textContent.split('\n')[1]),
        appttime: cleanText(cells[13].querySelector('.text-muted')?.textContent || cells[13].textContent.split('\n')[2] || ''),
        apptperson: cleanText(cells[14].querySelector('.text-truncate-custom')?.textContent || cells[14].textContent),
        appttel: cleanText(cells[15].querySelector('small')?.textContent || cells[15].textContent),
        apptaddr: cleanText(cells[16].querySelector('.text-truncate-custom')?.textContent || cells[16].textContent),
        email: cleanText(cells[17].querySelector('small')?.textContent || cells[17].textContent)
    };

    // Store selected delivery data for export
    selectedDeliveryData = deliveryData;
    
    // Generate detail content
    const detailContent = generateDetailContent(deliveryData);
    document.getElementById('detailContent').innerHTML = detailContent;
    
    // Load related deliveries with same delivernum
    loadRelatedDeliveries(deliveryData.delivernum);
    
    // Show detail form section
    const detailSection = document.getElementById('detailFormSection');
    detailSection.style.display = 'block';
    
    // Scroll to detail section
    detailSection.scrollIntoView({ behavior: 'smooth' });
}

function hideDetailForm() {
    const detailSection = document.getElementById('detailFormSection');
    detailSection.style.display = 'none';
    
    // Remove active class from all rows
    const table = document.getElementById('deliveriesTable');
    const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
    for (let i = 0; i < rows.length; i++) {
        rows[i].classList.remove('table-active');
    }
}

// ตัวแปรเก็บข้อมูลที่เลือก
let selectedDeliveryData = null;

// ฟังก์ชันส่งออกข้อมูลที่เลือก
function exportSelectedData() {
    if (!selectedDeliveryData) {
        alert('กรุณาเลือกข้อมูลก่อน');
        return;
    }
    
    // สร้าง CSV content
    const csvContent = generateCSVContent([selectedDeliveryData]);
    
    // ดาวน์โหลดไฟล์
    downloadCSV(csvContent, `ข้อมูลที่เลือก_${selectedDeliveryData.delivernum}.csv`);
}

// ฟังก์ชันส่งออกข้อมูลทั้งหมดที่เกี่ยวข้อง
async function exportAllRelatedData() {
    if (!selectedDeliveryData) {
        alert('กรุณาเลือกข้อมูลก่อน');
        return;
    }
    
    try {
        // ดึงข้อมูลทั้งหมดที่เกี่ยวข้อง
        const response = await fetch(`/dashboard/api/related-deliveries?delivernum=${encodeURIComponent(selectedDeliveryData.delivernum)}`);
        const result = await response.json();
        
        if (result.success && result.data.length > 0) {
            // สร้าง CSV content
            const csvContent = generateCSVContent(result.data);
            
            // ดาวน์โหลดไฟล์
            downloadCSV(csvContent, `ข้อมูลทั้งหมด_${selectedDeliveryData.delivernum}.csv`);
        } else {
            alert('ไม่พบข้อมูลที่เกี่ยวข้อง');
        }
    } catch (error) {
        console.error('Error exporting data:', error);
        alert('เกิดข้อผิดพลาดในการส่งออกข้อมูล');
    }
}

// ฟังก์ชันสร้าง CSV content ตามโครงสร้าง legacy_deliveries
function generateCSVContent(data) {
    // Headers ตามโครงสร้าง legacy_deliveries table
    const headers = [
        'id', 'workdate', 'worktime', 'operator', 'chkminute', 'delivernum', 'tohomenum', 'timein', 'timeout', 'buy',
        'datatype', 'datadesc', 'processtyp', 'processdes', 'mediatype', 'mediadesc', 'channel', 'channeldes',
        'paytype', 'paydesc', 'paytype1', 'subpay1', 'subpay2', 'payment', 'payday', 'cusbankno', 'cusbankna', 'cusbankbr', 'cusbankac', 'cusbankref',
        'credit', 'credittype', 'creditdesc', 'creditno', 'creditexpm', 'creditexpy', 'creditref', 'last3digit',
        'bankno', 'bankna', 'bankbr', 'bankac', 'bankref', 'shiptype', 'shipdesc', 'shipcost', 'shipfree',
        'code', 'title', 'cost', 'price', 'qty', 'amount', 'discount', 'subtotal', 'total',
        'apptday', 'apptdate', 'appttime', 'appttime1', 'appttime2', 'apptperson', 'appttel', 'apptaddr', 'apptaddr1', 'apptaddr2', 'apptkwang', 'apptkate', 'appttumbon',
        'prename', 'firstname', 'lastname', 'customerid', 'mobiletel', 'emailaddr', 'lineid', 'birthday', 'sex', 'age', 'weight', 'height',
        'homenum', 'moo', 'building', 'soi', 'road', 'kwang', 'kate', 'province', 'zipcode', 'addr1', 'addr2', 'addr3', 'addr4', 'addr5',
        'homenum1', 'mooban1', 'soi1', 'road1', 'kwang1', 'kate1', 'province1', 'zipcode1', 'addr1_1', 'addr2_1', 'addr3_1', 'addr4_1', 'addr5_1',
        'homenum2', 'mooban2', 'soi2', 'road2', 'kwang2', 'kate2', 'province2', 'zipcode2', 'addr1_2', 'addr2_2', 'addr3_2', 'addr4_2', 'addr5_2',
        'sickness1', 'sickness2', 'custtag', 'salerepid', 'salename', 'source', 'signdate', 'baned', 'banremark',
        'transfer', 'scanflag', 'scandate', 'scantime', 'scanby', 'feed', 'feedno', 'feedback', 'feeddesc', 'feeddate', 'feedtime', 'feedid', 'feedmemo',
        'weightloss', 'weight', 'remark1', 'remark2', 'statusid', 'statusdesc', 'finish', 'mapstat', 'uniqueid',
        'accprint', 'accprintd', 'accprintt', 'nkprint', 'nkprintd', 'nkprintt', 'routedate', 'editno', 'editflag', 'cnflag', 'followup'
    ];
    
    const csvRows = [headers.join(',')];
    
    data.forEach(delivery => {
        const row = [
            delivery.id || '',
            delivery.workdate || '',
            delivery.worktime || '',
            delivery.operator || '',
            delivery.chkminute || '',
            delivery.delivernum || '',
            delivery.tohomenum || '',
            delivery.timein || '',
            delivery.timeout || '',
            delivery.buy || '',
            delivery.datatype || '',
            delivery.datadesc || '',
            delivery.processtyp || '',
            delivery.processdes || '',
            delivery.mediatype || '',
            delivery.mediadesc || '',
            delivery.channel || '',
            delivery.channeldes || '',
            delivery.paytype || '',
            delivery.paydesc || '',
            delivery.paytype1 || '',
            delivery.subpay1 || '',
            delivery.subpay2 || '',
            delivery.payment || '',
            delivery.payday || '',
            delivery.cusbankno || '',
            delivery.cusbankna || '',
            delivery.cusbankbr || '',
            delivery.cusbankac || '',
            delivery.cusbankref || '',
            delivery.credit || '',
            delivery.credittype || '',
            delivery.creditdesc || '',
            delivery.creditno || '',
            delivery.creditexpm || '',
            delivery.creditexpy || '',
            delivery.creditref || '',
            delivery.last3digit || '',
            delivery.bankno || '',
            delivery.bankna || '',
            delivery.bankbr || '',
            delivery.bankac || '',
            delivery.bankref || '',
            delivery.shiptype || '',
            delivery.shipdesc || '',
            delivery.shipcost || '',
            delivery.shipfree || '',
            delivery.code || '',
            delivery.title || '',
            delivery.cost || '',
            delivery.price || '',
            delivery.qty || '',
            delivery.amount || '',
            delivery.discount || '',
            delivery.subtotal || '',
            delivery.total || '',
            delivery.apptday || '',
            delivery.apptdate || '',
            delivery.appttime || '',
            delivery.appttime1 || '',
            delivery.appttime2 || '',
            delivery.apptperson || '',
            delivery.appttel || '',
            delivery.apptaddr || '',
            delivery.apptaddr1 || '',
            delivery.apptaddr2 || '',
            delivery.apptkwang || '',
            delivery.apptkate || '',
            delivery.appttumbon || '',
            delivery.prename || '',
            delivery.firstname || '',
            delivery.lastname || '',
            delivery.customerid || '',
            delivery.mobiletel || '',
            delivery.emailaddr || '',
            delivery.lineid || '',
            delivery.birthday || '',
            delivery.sex || '',
            delivery.age || '',
            delivery.weight || '',
            delivery.height || '',
            delivery.homenum || '',
            delivery.moo || '',
            delivery.building || '',
            delivery.soi || '',
            delivery.road || '',
            delivery.kwang || '',
            delivery.kate || '',
            delivery.province || '',
            delivery.zipcode || '',
            delivery.addr1 || '',
            delivery.addr2 || '',
            delivery.addr3 || '',
            delivery.addr4 || '',
            delivery.addr5 || '',
            delivery.homenum1 || '',
            delivery.mooban1 || '',
            delivery.soi1 || '',
            delivery.road1 || '',
            delivery.kwang1 || '',
            delivery.kate1 || '',
            delivery.province1 || '',
            delivery.zipcode1 || '',
            delivery.addr1_1 || '',
            delivery.addr2_1 || '',
            delivery.addr3_1 || '',
            delivery.addr4_1 || '',
            delivery.addr5_1 || '',
            delivery.homenum2 || '',
            delivery.mooban2 || '',
            delivery.soi2 || '',
            delivery.road2 || '',
            delivery.kwang2 || '',
            delivery.kate2 || '',
            delivery.province2 || '',
            delivery.zipcode2 || '',
            delivery.addr1_2 || '',
            delivery.addr2_2 || '',
            delivery.addr3_2 || '',
            delivery.addr4_2 || '',
            delivery.addr5_2 || '',
            delivery.sickness1 || '',
            delivery.sickness2 || '',
            delivery.custtag || '',
            delivery.salerepid || '',
            delivery.salename || '',
            delivery.source || '',
            delivery.signdate || '',
            delivery.baned || '',
            delivery.banremark || '',
            delivery.transfer || '',
            delivery.scanflag || '',
            delivery.scandate || '',
            delivery.scantime || '',
            delivery.scanby || '',
            delivery.feed || '',
            delivery.feedno || '',
            delivery.feedback || '',
            delivery.feeddesc || '',
            delivery.feeddate || '',
            delivery.feedtime || '',
            delivery.feedid || '',
            delivery.feedmemo || '',
            delivery.weightloss || '',
            delivery.weight || '',
            delivery.remark1 || '',
            delivery.remark2 || '',
            delivery.statusid || '',
            delivery.statusdesc || '',
            delivery.finish || '',
            delivery.mapstat || '',
            delivery.uniqueid || '',
            delivery.accprint || '',
            delivery.accprintd || '',
            delivery.accprintt || '',
            delivery.nkprint || '',
            delivery.nkprintd || '',
            delivery.nkprintt || '',
            delivery.routedate || '',
            delivery.editno || '',
            delivery.editflag || '',
            delivery.cnflag || '',
            delivery.followup || ''
        ];
        
        // Escape commas and quotes in CSV
        const escapedRow = row.map(field => {
            const stringField = String(field || '');
            if (stringField.includes(',') || stringField.includes('"') || stringField.includes('\n')) {
                return `"${stringField.replace(/"/g, '""')}"`;
            }
            return stringField;
        });
        
        csvRows.push(escapedRow.join(','));
    });
    
    return csvRows.join('\n');
}

// ฟังก์ชันดาวน์โหลด CSV
function downloadCSV(csvContent, filename) {
    const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    link.setAttribute('href', url);
    link.setAttribute('download', filename);
    link.style.visibility = 'hidden';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Function to load related deliveries with same delivernum
async function loadRelatedDeliveries(delivernum) {
    try {
        const response = await fetch(`/dashboard/api/related-deliveries?delivernum=${encodeURIComponent(delivernum)}`);
        const result = await response.json();
        
        if (result.success && result.data.length > 0) {
            // Add related deliveries table
            const relatedTable = generateRelatedDeliveriesTable(result.data);
            const detailContent = document.getElementById('detailContent');
            
            // Insert the table before the first card
            const firstCard = detailContent.querySelector('.card');
            if (firstCard) {
                firstCard.insertAdjacentHTML('beforebegin', relatedTable);
            }
        }
    } catch (error) {
        console.error('Error loading related deliveries:', error);
    }
}

// Function to generate related deliveries table
function generateRelatedDeliveriesTable(deliveries) {
    const tableRows = deliveries.map(delivery => `
        <tr>
            <td>${delivery.id || ''}</td>
            <td>${formatThaiDate(delivery.workdate)}</td>
            <td>${formatThaiTime(delivery.worktime)}</td>
            <td>${delivery.operator || ''}</td>
            <td>
                <span class="badge ${delivery.datadesc === 'ขาย' ? 'bg-success' : delivery.datadesc === 'ค่าส่ง' ? 'bg-info' : 'bg-warning'}">${delivery.datadesc || ''}</span>
            </td>
            <td>${delivery.title || ''}</td>
            <td class="text-center">${delivery.qty || 0}</td>
            <td class="text-end">฿${parseFloat(delivery.price || 0).toLocaleString('th-TH', {minimumFractionDigits: 2})}</td>
            <td class="text-end">
                <strong>฿${parseFloat(delivery.total || 0).toLocaleString('th-TH', {minimumFractionDigits: 2})}</strong>
            </td>
        </tr>
    `).join('');
    
    return `
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h6 class="mb-0">
                        <i class="bi bi-list-ul me-2"></i>
                        รายการที่เกี่ยวข้อง (หมายเลขการจัดส่ง: ${deliveries[0]?.delivernum || ''})
                    </h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>วันที่</th>
                                    <th>เวลา</th>
                                    <th>พนักงาน</th>
                                    <th>ประเภท</th>
                                    <th>สินค้า</th>
                                    <th>จำนวน</th>
                                    <th>ราคา</th>
                                    <th>ยอดรวม</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRows}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function generateDetailContent(data) {
    return `
        <div class="row">
            <!-- Customer Information -->
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0">
                            <i class="bi bi-person-fill me-2"></i>
                            ข้อมูลลูกค้า
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">หมายเลขลูกค้า (CustID):</label>
                                    <input type="text" class="form-control" value="${data.customerid}" readonly>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">ชื่อ-นามสกุล:</label>
                                    <input type="text" class="form-control" value="${data.customer}" readonly>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">อีเมล:</label>
                                    <input type="text" class="form-control" value="${data.email}" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">หมายเลขการจัดส่ง:</label>
                                    <input type="text" class="form-control" value="${data.delivernum}" readonly>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">วันที่ทำรายการ:</label>
                                    <input type="text" class="form-control" value="${formatThaiDate(data.workdate)}" readonly>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">เวลาทำรายการ:</label>
                                    <input type="text" class="form-control" value="${formatThaiTime(data.worktime)}" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Order Information -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0">
                            <i class="bi bi-cart-fill me-2"></i>
                            ข้อมูลการสั่งซื้อ
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label fw-bold">ประเภทรายการ:</label>
                            <input type="text" class="form-control" value="${data.datadesc}" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">สินค้า:</label>
                            <input type="text" class="form-control" value="${data.title}" readonly>
                        </div>
                        <div class="row">
                            <div class="col-4">
                                <label class="form-label fw-bold">จำนวน:</label>
                                <input type="text" class="form-control" value="${data.qty}" readonly>
                            </div>
                            <div class="col-4">
                                <label class="form-label fw-bold">ราคา:</label>
                                <input type="text" class="form-control" value="${data.price}" readonly>
                            </div>
                            <div class="col-4">
                                <label class="form-label fw-bold">ยอดรวม:</label>
                                <input type="text" class="form-control fw-bold text-success" value="${data.total}" readonly>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Delivery Information -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">
                            <i class="bi bi-truck-fill me-2"></i>
                            ข้อมูลการจัดส่ง
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label fw-bold">การขนส่ง:</label>
                            <input type="text" class="form-control" value="${data.shipping}" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">วันที่ส่ง:</label>
                            <input type="text" class="form-control" value="${formatThaiDate(data.apptday)}" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">วันที่นัดส่ง:</label>
                            <input type="text" class="form-control" value="${formatThaiDate(data.apptdate)}" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">เวลาส่ง:</label>
                            <input type="text" class="form-control" value="${formatThaiTime(data.appttime)}" readonly>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contact Information -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h6 class="mb-0">
                            <i class="bi bi-person-lines-fill me-2"></i>
                            ข้อมูลผู้รับ
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label fw-bold">ชื่อผู้รับ:</label>
                            <input type="text" class="form-control" value="${data.apptperson}" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">โทรศัพท์:</label>
                            <input type="text" class="form-control" value="${data.appttel}" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">ที่อยู่จัดส่ง:</label>
                            <textarea class="form-control" rows="3" readonly>${data.apptaddr}</textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Channel Information -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header bg-secondary text-white">
                        <h6 class="mb-0">
                            <i class="bi bi-broadcast me-2"></i>
                            ช่องทางและชำระเงิน
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label fw-bold">รายการสื่อ (Media):</label>
                            <input type="text" class="form-control" value="${data.media}" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">รายการช่องทาง (Channel):</label>
                            <input type="text" class="form-control" value="${data.channel}" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">การชำระเงิน:</label>
                            <textarea class="form-control" rows="2" readonly>${data.payment}</textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">พนักงาน:</label>
                            <input type="text" class="form-control" value="${data.operator}" readonly>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function printDetail() {
    const modalContent = document.getElementById('detailContent');
    const printWindow = window.open('', '_blank');
    
    printWindow.document.write(`
        <html>
            <head>
                <title>รายละเอียดการจัดส่ง</title>
                <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
                <style>
                    @media print {
                        .card { border: 1px solid #ddd; margin-bottom: 15px; }
                        .card-header { background-color: #f8f9fa !important; color: #000 !important; }
                        .form-control { border: none; background: transparent; padding: 0; }
                        .fw-bold { font-weight: bold; }
                    }
                </style>
            </head>
            <body>
                <div class="container mt-3">
                    <h2 class="text-center mb-4">รายละเอียดการจัดส่ง</h2>
                    ${modalContent.innerHTML}
                </div>
            </body>
        </html>
    `);
    
    printWindow.document.close();
    printWindow.print();
}
</script>
